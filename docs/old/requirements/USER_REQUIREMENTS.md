# 用户需求文档 (User Requirements Document)

**项目名称**: 影像数据平台 - AI辅助报告筛选系统
**文档版本**: v2.0.0 (Phase 1)
**最后更新**: 2024-12-01
**文档状态**: 正式版 - Phase 1聚焦

---

## 文档概述

### 目的
本文档描述了影像数据平台Phase 1的用户需求，聚焦于**AI辅助报告分析和项目管理**功能。系统旨在帮助研究人员在从PACS下载影像数据之前，通过本地LLM对检查报告进行智能筛选和标记。

### Phase 1核心定位
**不是**：完整的PACS影像管理系统
**而是**：PACS下载前的数据准备和筛选工具

### 范围
- ✅ Phase 1（本文档）: 报告搜索、AI分析、项目管理、数据导出
- 🔄 Phase 2（未来）: DICOM影像管理、查看器、对象存储

### 读者对象
- 医学研究人员（主要用户）
- 数据分析师
- 系统管理员
- 开发团队

---

## 1. 项目背景

### 1.1 业务背景
医院和研究机构需要从PACS系统下载大量医学影像数据用于研究。在下载之前，研究人员需要根据检查报告筛选符合研究标准的病例，但手动阅读和筛选数百份报告非常耗时。

### 1.2 现状问题
- **手动筛选效率低**: 人工阅读报告寻找关键信息，耗时巨大
- **筛选标准不一致**: 不同研究人员对同一报告的判断可能不同
- **缺乏结构化标记**: 无法保存筛选标准和AI分析结果用于后续过滤
- **数据组织混乱**: 缺乏项目管理机制来组织和追踪筛选结果
- **重复劳动**: 相似的筛选任务需要重复执行

### 1.3 Phase 1目标
构建一个AI辅助的报告筛选和项目管理系统，实现：
- 📊 **数据导入**: 快速导入检查数据和报告
- 🔍 **智能搜索**: 高效检索检查记录和报告
- 🤖 **AI分析**: 使用本地LLM根据用户提示标记报告关键信息
- 💾 **项目管理**: 将筛选结果保存为项目便于管理
- 📤 **数据导出**: 导出筛选结果用于PACS下载准备
- ⚡ **简单高效**: UI/UX专注于快速操作和高效工作流

### 1.4 Phase 2展望（未实现）
- DICOM影像上传和存储
- Web端影像查看器
- 影像下载和管理
- 复杂的系统集成（Accssyn、Red Report自动同步）

---

## 2. 用户角色定义

### 2.1 研究人员（Researcher）- 主要用户
**角色描述**: 使用系统筛选符合研究标准的检查报告，为后续PACS下载做准备

**主要职责**:
- 导入检查数据和报告
- 搜索和浏览检查报告
- 使用AI分析报告内容
- 根据AI标记筛选数据
- 创建和管理研究项目
- 导出筛选结果

**使用频率**: 每周3-5次
**技能水平**: 医学背景，基本计算机操作
**访问权限**: 数据导入、报告查看、AI分析、项目管理

### 2.2 系统管理员（Admin）
**角色描述**: 管理用户账号和系统配置

**主要职责**:
- 创建和管理用户账号
- 配置Ollama LLM参数
- 监控系统使用情况
- 数据备份和维护

**使用频率**: 每周1-2次
**技能水平**: IT技术背景
**访问权限**: 所有功能

---

## 3. 功能需求

### 3.1 用户认证（简化版）

#### UR-001: 用户登录
**优先级**: 高
**需求描述**: 用户通过用户名和密码登录系统

**详细需求**:
- 用户输入用户名/邮箱和密码
- 系统验证凭证有效性
- 登录成功后跳转到主页面
- 登录失败显示错误提示
- JWT令牌认证（30分钟有效期）

**验收标准**:
- ✅ 正确凭证可以成功登录
- ✅ 错误凭证显示明确错误信息
- ✅ 会话在30分钟内保持活跃
- ✅ 密码使用bcrypt加密存储

**Phase 1简化说明**:
- 不支持"记住我"功能
- 不支持多设备管理
- 基本的单用户或小团队认证即可

---

### 3.2 数据导入和管理

#### UR-002: 检查数据导入
**优先级**: 高
**需求描述**: 导入检查记录和报告数据到系统

**详细需求**:
- **方式一：文件导入**
  - 支持Excel (.xlsx)和CSV格式
  - 上传文件后预览数据
  - 配置字段映射（灵活适配不同数据源）
  - 批量导入检查记录

- **方式二：数据库连接**（可选）
  - 配置数据库连接信息（PostgreSQL/MySQL）
  - 选择要导入的表
  - 定义数据同步规则
  - 执行一次性或定期导入

- **数据字段**:
  - 患者ID/姓名（基本信息）
  - 检查日期、检查类型（CT/MRI/X-Ray等）
  - 检查描述、科室
  - **报告内容**（最重要）
  - 诊断ICD编码（可选）

- **数据验证**:
  - 检查必填字段完整性
  - 日期格式验证
  - 重复数据检测和处理

**验收标准**:
- ✅ 支持Excel和CSV格式导入
- ✅ 字段映射灵活可配置
- ✅ 导入速度 > 500条/分钟
- ✅ 显示导入进度和结果统计
- ✅ 重复数据可以选择跳过或覆盖

**Phase 1简化说明**:
- 暂不支持DICOM文件导入
- 暂不支持自动同步（仅手动导入）

---

### 3.3 报告搜索和浏览

#### UR-003: 检查记录搜索
**优先级**: 高
**需求描述**: 快速搜索和筛选检查记录

**详细需求**:
- **搜索方式**:
  - 关键词搜索（患者ID、姓名、报告内容）
  - 高级筛选：
    - 检查日期范围
    - 检查类型（CT、MRI、X-Ray等）
    - 科室/病区
    - 是否有AI标记
    - AI标记类型/内容

- **结果展示**:
  - 列表显示（分页，每页50条）
  - 显示：患者ID、姓名、检查日期、检查类型、报告摘要
  - 高亮显示搜索关键词
  - 标记已分析和未分析的记录

- **快速操作**:
  - 点击查看报告详情
  - 批量选择记录
  - 添加到项目
  - 批量AI分析

**验收标准**:
- ✅ 搜索响应时间 < 2秒
- ✅ 支持中文分词和模糊搜索
- ✅ 筛选条件可以组合使用
- ✅ 结果可以按日期/相关性排序

#### UR-004: 报告详情查看
**优先级**: 高
**需求描述**: 查看检查报告的完整内容和AI分析结果

**详细需求**:
- **报告显示**:
  - 患者基本信息
  - 检查基本信息（日期、类型、科室）
  - 报告完整内容（格式化显示）
  - 关联的诊断ICD编码（如有）

- **AI标记显示**:
  - 显示所有AI分析历史
  - 每条标记显示：
    - 用户提示词
    - AI分析结果（高亮/分类/提取的信息）
    - 标记时间
    - 置信度（如有）
  - 支持折叠/展开标记详情

- **快速操作**:
  - 新建AI分析
  - 编辑/删除AI标记
  - 添加到项目
  - 导出报告（PDF）

**验收标准**:
- ✅ 报告内容清晰易读
- ✅ AI标记醒目显示
- ✅ 页面加载时间 < 2秒
- ✅ 支持键盘快捷键切换报告

---

### 3.4 AI辅助报告分析（核心功能）

#### UR-005: AI报告分析
**优先级**: 高（核心）
**需求描述**: 使用本地LLM根据用户提示分析报告内容并生成结构化标记

**详细需求**:

- **分析触发**:
  - 单个报告分析
  - 批量报告分析（最多50条）
  - 在报告详情页发起分析
  - 在搜索结果页批量分析

- **用户提示词输入**:
  - 提供文本框输入自定义提示
  - 提供常用提示模板：
    - "提取报告中的关键发现和诊断结论"
    - "标记报告中提到的病灶位置和大小"
    - "判断是否包含恶性肿瘤相关描述"
    - "提取所有测量数值和单位"
    - "分类报告严重程度（正常/轻度/中度/重度）"
  - 支持保存自定义提示为模板

- **AI处理流程**:
  1. 用户输入提示词
  2. 系统调用Ollama本地LLM（qwen2.5:7b）
  3. 构建系统提示："你是一个医学影像报告分析助手..."
  4. 组合用户提示 + 报告内容发送给LLM
  5. LLM返回JSON格式的分析结果
  6. 系统解析并保存标记

- **标记类型支持**:
  - **高亮标记**: 标记报告中的关键短语或句子
  - **分类标记**: 将报告分为不同类别（正常/异常、良性/恶性等）
  - **提取标记**: 提取结构化信息（病灶位置、大小、测量值等）
  - **评分标记**: 给出严重程度评分或置信度
  - **自由文本**: AI的总结性描述

- **分析结果显示**:
  - 实时显示分析进度（单个报告2-5秒）
  - 高亮显示AI标记的文本
  - 以卡片形式展示结构化信息
  - 显示AI的置信度（如有）
  - 支持手动修改AI标记

- **批量分析**:
  - 显示总体进度条
  - 显示每条记录的分析状态（待处理/处理中/已完成/失败）
  - 失败的记录显示错误原因
  - 可以暂停/恢复批量分析
  - 分析完成后发送通知

**验收标准**:
- ✅ 单个报告分析时间 < 5秒
- ✅ 批量分析并发数 ≥ 3（可配置）
- ✅ AI返回结构化JSON结果
- ✅ 分析结果准确保存到数据库
- ✅ 支持查看分析历史
- ✅ 错误处理完善（LLM不可用、超时等）

**技术要求**:
- 使用Ollama本地部署（推荐模型：qwen2.5:7b）
- 提示工程优化（系统提示 + 少样本示例）
- JSON输出模式保证结果结构化
- 异步处理避免阻塞UI

#### UR-006: AI标记管理
**优先级**: 高
**需求描述**: 管理和利用AI分析生成的标记进行数据筛选

**详细需求**:

- **标记浏览**:
  - 查看某个报告的所有AI标记
  - 按标记类型筛选
  - 按标记时间排序

- **标记编辑**:
  - 修改AI标记的内容（纠正错误）
  - 添加手动标记
  - 删除无用标记
  - 标记置信度调整

- **基于标记的筛选**:
  - 在搜索中添加"AI标记"筛选条件：
    - 包含特定标记类型
    - 标记内容包含关键词
    - 特定分类的报告（如：只显示"异常"报告）
    - 特定严重程度的报告
  - 组合多个标记条件进行精确筛选

- **标记统计**:
  - 查看标记类型分布
  - 查看分类统计（如：正常/异常比例）
  - 查看标记使用频率

**验收标准**:
- ✅ 标记可以正常增删改查
- ✅ 基于标记的筛选准确有效
- ✅ 支持复杂的标记条件组合
- ✅ 标记操作有历史记录

---

### 3.5 项目管理（核心功能）

#### UR-007: 项目创建和管理
**优先级**: 高（核心）
**需求描述**: 将筛选出的检查记录保存为项目，便于组织和追踪

**详细需求**:

- **项目创建**:
  - 输入项目名称（必填）
  - 输入项目描述（可选）
  - 选择项目标签/分类（可选）
  - 设置项目创建日期

- **添加数据到项目**:
  - 从搜索结果批量添加
  - 从报告详情页单个添加
  - 支持拖拽添加（可选）
  - 显示添加成功提示

- **项目列表**:
  - 显示所有项目
  - 每个项目显示：
    - 项目名称和描述
    - 包含的检查记录数量
    - 创建时间
    - 最后修改时间
  - 按创建时间/名称排序
  - 支持搜索项目

- **项目详情**:
  - 显示项目基本信息
  - 显示项目包含的所有检查记录
  - 记录列表支持筛选和排序
  - 显示AI标记统计信息
  - 支持添加项目备注

- **项目操作**:
  - 编辑项目信息
  - 从项目中移除记录
  - 删除项目（可选是否删除数据）
  - 复制项目
  - 合并项目

**验收标准**:
- ✅ 项目创建流程简单快速
- ✅ 支持一键添加搜索结果到项目
- ✅ 项目中的记录可以灵活管理
- ✅ 项目列表加载速度快
- ✅ 项目数据关联正确

#### UR-008: 项目数据导出
**优先级**: 高
**需求描述**: 导出项目数据用于PACS下载准备或进一步分析

**详细需求**:

- **导出格式**:
  - **Excel格式** (.xlsx):
    - 包含所有检查记录字段
    - 包含AI标记摘要
    - 格式化清晰易读
  - **CSV格式**:
    - 标准CSV格式
    - UTF-8编码
    - 适合编程处理
  - **JSON格式** (可选):
    - 包含完整的AI标记详情
    - 适合技术用户

- **导出内容可选**:
  - 基本信息（患者ID、姓名、检查日期等）
  - 报告全文
  - AI标记摘要
  - AI标记详细内容
  - 统计信息

- **导出选项**:
  - 导出整个项目
  - 导出筛选后的记录
  - 选择特定字段导出

- **导出后操作**:
  - 直接下载文件
  - 查看导出历史
  - 重新下载之前的导出

**验收标准**:
- ✅ Excel导出格式正确美观
- ✅ CSV导出UTF-8编码无乱码
- ✅ 导出速度 > 1000条/分钟
- ✅ 支持大数据集导出（10,000+记录）
- ✅ 导出文件命名规范（项目名_日期.xlsx）

---

### 3.6 UI/UX高效性

#### UR-009: 简单高效的用户界面
**优先级**: 高（核心）
**需求描述**: 提供简洁、高效、易用的用户界面

**详细需求**:

- **简洁设计**:
  - 扁平化设计风格
  - 清晰的视觉层次
  - 最小化干扰元素
  - 突出核心功能

- **快速操作**:
  - 键盘快捷键支持：
    - Ctrl+K: 快速搜索
    - Ctrl+N: 新建项目
    - Ctrl+A: AI分析当前报告
    - 方向键: 浏览报告列表
    - Enter: 查看报告详情
  - 右键菜单快速操作
  - 批量操作工具栏

- **智能交互**:
  - 自动保存用户偏好（筛选条件、列显示等）
  - 记住上次浏览位置
  - 智能提示和自动完成
  - 操作反馈及时明确

- **响应式设计**:
  - 支持桌面端（1920x1080及以上）
  - 支持平板端查看（可选）
  - 自适应布局

- **性能优化**:
  - 虚拟滚动（大列表）
  - 懒加载（图片和内容）
  - 前端缓存（搜索结果、项目列表）
  - 加载状态明确显示

**验收标准**:
- ✅ 核心操作 ≤ 3步完成
- ✅ 键盘快捷键覆盖常用功能
- ✅ 页面加载时间 < 2秒
- ✅ 大列表（1000+条）流畅滚动
- ✅ 用户满意度 > 85%

---

## 4. 非功能需求

### 4.1 性能需求

#### NFR-001: 响应时间
- **API响应时间**: < 1秒（90%请求）
- **搜索响应时间**: < 2秒（全文搜索）
- **AI分析时间**: < 5秒（单个报告）
- **页面加载时间**: < 2秒

#### NFR-002: 吞吐量
- **并发用户数**: 支持10+并发用户（小团队）
- **数据导入速度**: > 500条/分钟
- **AI分析并发**: 3-5个报告同时分析
- **导出速度**: > 1000条/分钟

#### NFR-003: 数据容量
- **检查记录**: 支持100,000+记录
- **报告数据**: 支持100,000+报告
- **AI标记**: 支持500,000+标记记录
- **项目数**: 支持1,000+项目

### 4.2 可用性需求

#### NFR-004: 系统可用性
- **可用性目标**: 95%（开发/测试环境）
- **启动时间**: < 1分钟（Docker启动）
- **数据备份**: 每日自动备份

#### NFR-005: 用户界面可用性
- **响应式设计**: 主要支持桌面端
- **浏览器兼容**: Chrome 90+, Edge 90+
- **操作步骤**: 核心功能 ≤ 3步完成
- **错误提示**: 清晰明确的错误信息

### 4.3 安全需求

#### NFR-006: 认证和授权（简化）
- **密码强度**: 最少8位
- **会话超时**: 30分钟无操作自动登出
- **令牌有效期**: JWT 30分钟
- **权限控制**: 基本的角色权限控制

#### NFR-007: 数据安全
- **传输加密**: HTTPS（生产环境）
- **密码存储**: bcrypt加密
- **数据脱敏**: 日志中不包含敏感信息

### 4.4 可维护性需求

#### NFR-008: 代码质量
- **代码规范**: PEP 8（Python）, ESLint（TypeScript）
- **测试覆盖率**: 核心功能单元测试 > 70%
- **代码注释**: 关键逻辑添加注释
- **文档**: API文档、部署文档

#### NFR-009: 部署和配置
- **容器化**: Docker + Docker Compose
- **配置管理**: 环境变量配置
- **日志记录**: 结构化日志输出
- **监控**: 基本的健康检查端点

---

## 5. 约束条件

### 5.1 技术约束
- **前端**: React 18+ with TypeScript
- **后端**: Python FastAPI
- **数据库**: PostgreSQL 14+
- **LLM**: Ollama（本地部署）
- **推荐模型**: qwen2.5:7b
- **部署**: Docker Compose

### 5.2 业务约束
- **数据隐私**: 符合医疗数据保护规范
- **本地部署**: LLM和所有数据必须在本地
- **Phase 1限制**: 不处理DICOM影像文件

### 5.3 时间约束
- **开发周期**: 8周（Phase 1）
- **里程碑**:
  - Week 1-2: 数据导入和搜索
  - Week 3-4: AI分析集成
  - Week 5-6: 项目管理
  - Week 7: UI/UX优化
  - Week 8: 测试和部署

### 5.4 资源约束
- **团队规模**: 2-4人
- **服务器**:
  - CPU: 4核+（Ollama需要）
  - 内存: 16GB+（Ollama推荐）
  - 存储: 100GB+（初期）
  - GPU: 可选但推荐（加速LLM）

---

## 6. 验收标准

### 6.1 功能验收
- ✅ 数据导入功能完整（Excel/CSV）
- ✅ 搜索和筛选准确快速
- ✅ AI分析功能正常工作（Ollama集成）
- ✅ AI标记可以正确保存和使用
- ✅ 项目管理功能完整
- ✅ 数据导出格式正确

### 6.2 性能验收
- ✅ 搜索响应 < 2秒
- ✅ AI分析 < 5秒/报告
- ✅ 支持10+并发用户
- ✅ 大列表（1000+）流畅加载

### 6.3 AI功能验收
- ✅ Ollama正确部署和配置
- ✅ AI返回结构化结果
- ✅ 批量分析稳定运行
- ✅ 错误处理完善

### 6.4 用户验收
- ✅ 研究人员可以独立完成数据筛选
- ✅ AI分析结果有价值
- ✅ 项目管理方便高效
- ✅ 导出数据可直接用于PACS下载准备
- ✅ UI/UX简单高效
- ✅ 用户满意度 > 80%

---

## 7. 与Phase 2的关系

### Phase 1 → Phase 2 过渡
Phase 1完成后，系统已具备：
- ✅ 完整的检查记录和报告数据库
- ✅ AI标记和项目组织
- ✅ 用户认证和权限基础

Phase 2将在此基础上添加：
- 📷 DICOM影像上传和存储（MinIO）
- 🖼️ Web端影像查看器（Cornerstone.js）
- 📥 影像下载管理
- 🔄 自动同步（Accssyn、Red Report）
- 📊 更复杂的报告工作流
- 🔐 企业级权限管理

---

## 8. 变更历史

| 版本 | 日期 | 变更内容 | 作者 |
|-----|------|---------|------|
| v2.0.0 | 2024-12-01 | Phase 1重构：聚焦AI报告分析和项目管理 | - |
| v1.0.0 | 2024-12-01 | 初始版本（完整平台） | - |

---

## 9. 附录

### 9.1 术语表

| 术语 | 定义 |
|-----|------|
| PACS | Picture Archiving and Communication System，影像归档和通信系统 |
| AI标记 | 由本地LLM根据用户提示生成的报告分析结果 |
| Ollama | 本地LLM部署工具 |
| Qwen2.5 | 阿里云开发的开源大语言模型 |
| 项目 | 用户创建的数据集合，用于组织筛选出的检查记录 |
| Phase 1 | 当前阶段，聚焦报告分析和项目管理 |
| Phase 2 | 未来阶段，添加DICOM影像管理功能 |

### 9.2 参考文档
- [项目概述](../01_PROJECT_OVERVIEW.md)
- [技术架构设计](../architecture/02_TECHNICAL_ARCHITECTURE.md)
- [数据库设计](../database/03_DATABASE_DESIGN.md)
- [API接口规范](../api/04_API_SPECIFICATION.md)
- [AI集成指南](../guides/AI_INTEGRATION_GUIDE.md)（待创建）

---

**文档批准**:

| 角色 | 姓名 | 签名 | 日期 |
|-----|------|------|------|
| 产品经理 | | | |
| 项目经理 | | | |
| 技术负责人 | | | |
| 用户代表（研究人员）| | | |
