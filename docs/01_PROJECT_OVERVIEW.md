# 影像数据平台项目概述

**版本**: v2.0.0
**最后更新**: 2024-12-01
**状态**: Phase 1 开发中 - AI辅助报告筛选系统

## 项目背景

基于2020-2024年PAPA数据和多源医疗检查报告，构建**AI驱动的报告筛选和管理平台**，用于PACS影像下载前的数据预处理和智能分析。本系统采用**本地LLM（Ollama）**实现报告内容的智能理解和标注，帮助研究人员高效筛选和组织临床研究数据。

### 核心价值

- **智能筛选**：AI辅助快速识别符合研究标准的报告
- **本地部署**：数据不出院内，保障患者隐私安全
- **高效管理**：项目化组织筛选结果，支持批量导出
- **研究友好**：为后续PACS影像下载提供精准的检查清单

## 项目目标

### Phase 1 目标（当前版本 - 8周）
1. **数据整合**：统一导入和管理多源检查报告数据（PAPA表、Red Report等）
2. **智能分析**：本地LLM驱动的报告内容理解和自动标注
3. **高效检索**：全文搜索和多维度筛选功能
4. **项目管理**：创建项目组织筛选结果，支持协作
5. **数据导出**：导出筛选清单用于PACS影像下载准备

### Phase 2 计划（未来扩展）
- DICOM影像预览和查看器集成
- 影像存储和管理（MinIO）
- Accssyn自动同步
- 高级统计分析和可视化

## 核心功能模块

### 1. 数据导入模块
**目标**：灵活导入多源检查报告数据

**功能清单**：
- **Excel/CSV导入**
  - 智能字段映射（拖拽配置）
  - 数据预览和验证（前100行）
  - 重复检测（基于patient_id + exam_date）
  - 批量导入（支持10,000+条记录）

- **数据源支持**
  - PAPA表数据（2020-2024）
  - Red Report手动导入
  - 自定义Excel格式

- **数据质量**
  - 必填字段验证（patient_id, exam_date, report_content）
  - 日期格式自动识别
  - 数据清洗和标准化

**技术实现**：
- Pandas处理Excel/CSV文件
- 前端字段映射界面（Ant Design Upload + DragDrop）
- 批量插入优化（100条/batch）

### 2. AI分析模块（核心功能）
**目标**：本地LLM驱动的报告智能理解和标注

**AI能力**：
- **单报告分析**
  - 用户自定义提示词
  - 4种标注类型：高亮(highlight)、分类(classification)、提取(extraction)、评分(scoring)
  - 实时反馈（30-60秒）

- **批量分析**
  - 并发处理（3-5个同时）
  - 后台任务队列
  - 进度追踪和错误处理
  - 支持50-100个报告/批次

- **提示词库**
  - 6个预置模板（关键发现、严重程度、病灶信息、测量值提取等）
  - 用户自定义提示词保存
  - 提示词管理和复用

**技术实现**：
- Ollama本地部署（推荐模型：qwen2.5:7b）
- FastAPI异步任务处理
- JSONB存储AI分析结果
- 置信度评分系统

**AI标注示例**：
```json
// 高亮关键发现
{
  "highlights": [
    {"text": "双肺纹理增多", "start": 15, "end": 22, "reason": "关键发现"}
  ]
}

// 严重程度分类
{
  "category": "moderate",
  "confidence": 0.85,
  "reasoning": "存在中度异常，需进一步检查"
}

// 提取测量值
{
  "measurements": [
    {"item": "结节直径", "value": "8", "unit": "mm", "location": "右肺上叶"}
  ]
}
```

### 3. 报告检索与筛选模块
**目标**：快速定位目标报告

**搜索功能**：
- **全文搜索**（PostgreSQL GIN索引）
  - 报告内容全文检索
  - 患者姓名/ID搜索
  - 中文分词支持

- **多条件筛选**
  - 时间范围（日期区间选择）
  - 检查类型（CT、MRI、X-Ray等）
  - 部门（病区、OPD）
  - ICD疾病编码

- **AI标注筛选**
  - 按AI分类结果过滤
  - 按严重程度筛选
  - 按置信度范围筛选
  
**列表工作区一致性（List Workbench）**：
- Phase 1 中，报告检索（Reports）、检查搜索（Study Search）与项目列表（Projects）三大页面的 UI 已统一采用 List Workbench 佈局：统一的 Header、条件卡片（FilterCard）、结果卡片（ResultsCard）。
- 所有列表页的【欄位設定】均使用右侧 Drawer 呈现，批次操作入口集中在结果卡片工具列与 Selected Drawer 内，减少不同页面间的学习成本。

**用户体验**：
- 实时搜索（输入即搜）
- 分页加载（20条/页）
- 虚拟滚动（大数据集优化）
- 快捷键支持（Ctrl+K唤起搜索）

### 4. 项目管理模块
**目标**：组织和管理筛选结果

**功能清单**：
- **项目CRUD**
  - 创建项目（名称、描述、标签）
  - 项目列表和详情
  - 项目归档和删除

- **报告关联**
  - 从搜索结果添加报告到项目
  - 批量添加（多选）
  - 添加备注说明

- **协作支持**
  - 项目创建者记录
  - 添加人追踪
  - 项目状态（active/archived/completed）

- **项目统计**
  - 报告数量统计
  - AI标注分布
  - 检查类型分布

### 5. 数据导出模块
**目标**：导出筛选清单用于PACS下载准备

**导出格式**：
- **Excel格式**（推荐）
  - 完整字段信息
  - AI标注结果
  - 格式化和样式

- **CSV格式**
  - 兼容性最佳
  - 大数据导出

- **JSON格式**
  - API集成友好
  - 完整数据结构

**导出选项**：
- 导出当前筛选结果
- 导出完整项目报告
- 自定义字段选择
- AI标注结果包含/排除

## 技术栈（Phase 1）

### 前端
```yaml
框架: React 18+ with TypeScript
UI组件库: Ant Design 5.x
状态管理: Zustand (轻量级)
HTTP客户端: Axios
构建工具: Vite 5.x
代码规范: ESLint + Prettier
```

### 后端
```yaml
Web框架: FastAPI 0.104+ (Python 3.10+)
ORM: SQLAlchemy 2.0+
数据验证: Pydantic 2.5+
迁移工具: Alembic
异步HTTP: httpx (调用Ollama)
密码加密: bcrypt
身份认证: JWT (python-jose)
```

### 数据库
```yaml
主数据库: PostgreSQL 14+
  - JSONB支持（AI标注存储）
  - 全文搜索（GIN索引）
  - 触发器和视图
```

### AI引擎
```yaml
LLM部署: Ollama (本地部署)
推荐模型: qwen2.5:7b (Alibaba开源)
备选模型:
  - llama3.1:8b
  - mistral:7b
  - gemma2:9b
```

### 基础设施
```yaml
容器化: Docker + Docker Compose
反向代理: Nginx (可选，本地部署可省略)
版本控制: Git
```

**Phase 1 移除的组件**：
- ❌ MinIO（对象存储）- Phase 2
- ❌ Redis（缓存）- Phase 2
- ❌ Celery（任务队列）- 使用FastAPI BackgroundTasks
- ❌ Cornerstone.js（DICOM查看器）- Phase 2
- ❌ Elasticsearch（搜索引擎）- PostgreSQL全文搜索足够

## 部署架构（Phase 1）

### 简化架构图
```
┌───────────────────────────────────────────────┐
│           Nginx (可选，仅生产环境)              │
├───────────────────────────────────────────────┤
│  Frontend (React)     │  Backend (FastAPI)    │
│  Port: 3000           │  Port: 8000           │
├───────────────────────┼───────────────────────┤
│  PostgreSQL 14+       │  Ollama LLM           │
│  Port: 5432           │  Port: 11434          │
└───────────────────────────────────────────────┘
```

### Docker Compose服务
```yaml
services:
  postgres:     # PostgreSQL 14+
  backend:      # FastAPI应用
  frontend:     # React应用
  ollama:       # Ollama LLM服务
```

## 项目里程碑（Phase 1 - 8周）

### Week 1-2: 基础架构搭建
**目标**：完成开发环境和核心框架

- [x] 数据库设计和初始化（5张表）
- [ ] Docker Compose环境配置
- [ ] FastAPI项目骨架
- [ ] React项目骨架
- [ ] Ollama安装和模型下载
- [ ] 基础API（用户认证、健康检查）

**交付物**：
- 可运行的Docker环境
- 登录功能
- 数据库初始化脚本

### Week 3-4: 数据导入与检索
**目标**：实现数据导入和基础检索

- [ ] Excel/CSV上传和解析
- [ ] 字段映射界面
- [ ] 批量数据导入
- [ ] 报告列表和分页
- [ ] 全文搜索实现
- [ ] 多条件筛选

**交付物**：
- 完整数据导入流程
- 可用的报告搜索界面

### Week 5-6: AI分析集成（核心）
**目标**：Ollama集成和AI标注功能

- [ ] Ollama API客户端开发
- [ ] 单报告AI分析
- [ ] 批量分析（后台任务）
- [ ] AI标注展示界面
- [ ] 提示词模板库
- [ ] 错误处理和重试机制

**交付物**：
- 完整AI分析工作流
- 6个预置提示词模板
- AI标注结果展示

### Week 7: 项目管理与导出
**目标**：项目功能和数据导出

- [ ] 项目CRUD接口和界面
- [ ] 报告添加到项目
- [ ] 项目统计视图
- [ ] Excel/CSV/JSON导出
- [ ] 批量操作优化

**交付物**：
- 完整项目管理功能
- 多格式数据导出

### Week 8: 测试与优化
**目标**：质量保证和性能优化

- [ ] 单元测试编写（覆盖率>70%）
- [ ] 集成测试（核心流程）
- [ ] 性能优化（查询、导出）
- [ ] UI/UX改进
- [ ] 用户文档编写
- [ ] 部署脚本

**交付物**：
- 测试报告
- 用户手册
- 部署文档

## 非功能需求

### 性能要求
| 指标 | 目标 | 说明 |
|------|------|------|
| 报告搜索响应 | < 2秒 | 10,000条数据集 |
| AI单报告分析 | 30-60秒 | qwen2.5:7b模型 |
| 批量导入速度 | >100条/秒 | PostgreSQL批量插入 |
| 并发用户数 | 10-20人 | 本地部署典型场景 |
| 数据导出速度 | 1000条/秒 | Excel格式 |

### 安全要求
- **数据隐私**：本地部署，数据不出院内网络
- **身份认证**：JWT令牌，30分钟过期
- **密码安全**：bcrypt加密，强密码策略
- **访问控制**：基于角色（admin/researcher）
- **审计日志**：用户操作追踪（创建/修改时间）

### 可用性要求
- **部署简单**：Docker Compose一键启动
- **数据备份**：PostgreSQL每日自动备份脚本
- **错误恢复**：AI分析失败自动重试（3次）
- **用户体验**：操作响应 < 200ms（前端交互）

## 风险评估与应对

| 风险项 | 影响 | 概率 | 应对措施 |
|--------|------|------|----------|
| Ollama模型准确性不足 | 高 | 中 | 提供多个模型选择，支持自定义提示词优化 |
| 历史数据质量问题 | 中 | 高 | 数据导入时严格验证，支持数据清洗 |
| AI分析速度慢 | 中 | 中 | 并发处理，后台任务，支持批量操作 |
| 中文医学术语理解 | 中 | 中 | 选择中文优化模型（qwen2.5），提示词工程 |
| GPU资源不足 | 低 | 低 | 使用CPU模式，推荐7B参数模型 |

## 项目团队建议

**Phase 1 最小团队配置**：
- **全栈开发**：1-2人（熟悉React + Python）
- **AI工程师**：1人（兼职，负责Ollama调优和提示词工程）
- **产品/测试**：1人（兼职，需求确认和验收测试）

**技能要求**：
- React + TypeScript（中级）
- Python + FastAPI（中级）
- PostgreSQL（基础）
- Docker（基础）
- AI/LLM基础知识（了解）

## 成功标准

### 功能完整性
- ✅ 导入10,000+条历史报告数据
- ✅ 全文搜索和多维筛选可用
- ✅ AI分析准确率 > 80%（人工抽查100份）
- ✅ 创建和管理至少3个研究项目
- ✅ 导出筛选清单用于PACS下载

### 用户满意度
- ✅ 数据导入流程 ≤ 5步
- ✅ 报告搜索到标注 ≤ 3次点击
- ✅ AI分析结果可理解和可信任
- ✅ 用户培训时间 ≤ 2小时

### 技术指标
- ✅ 单元测试覆盖率 > 70%
- ✅ 核心API响应时间 < 2秒
- ✅ 系统稳定运行 > 7天无重启
- ✅ Docker部署成功率 100%

## Phase 2 扩展规划（未来）

### 影像处理模块
- DICOM影像预览（Cornerstone.js）
- 影像存储（MinIO对象存储）
- 影像下载和批量导出

### 高级集成
- Accssyn自动数据同步
- PACS系统API对接
- HL7/FHIR标准支持

### 性能优化
- Redis缓存层
- Elasticsearch全文搜索
- Celery分布式任务队列

### 数据库扩展
- 独立patients表（患者主索引）
- studies表（检查级别管理）
- images表（影像元数据）

**迁移路径**：
- Phase 1的5张表设计已预留扩展能力
- 提供SQL迁移脚本（详见DATABASE_DESIGN.md）

## 后续文档

1. [技术架构设计](./architecture/02_TECHNICAL_ARCHITECTURE.md) - 系统架构和技术选型
2. [数据库设计](./database/03_DATABASE_DESIGN.md) - 5张核心表设计（已更新v2.0.0）
3. [API接口规范](./api/04_API_SPECIFICATION.md) - RESTful API详细文档
4. [用户需求文档](./requirements/USER_REQUIREMENTS.md) - 9条Phase 1需求（已更新v2.0.0）
5. [功能规格说明](./requirements/FUNCTIONAL_SPECIFICATION.md) - 技术实现详细规格（已更新v2.0.0）
6. [开发工作流](./workflow/05_DEVELOPMENT_WORKFLOW.md) - 8周开发计划
7. [AI集成指南](./guides/AI_INTEGRATION_GUIDE.md) - Ollama部署和调优（待创建）

---

**文档版本**: v2.0.0
**维护团队**: 影像数据平台开发团队
**最后审核**: 2024-12-01
